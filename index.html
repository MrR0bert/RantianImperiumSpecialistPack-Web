<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anno 1800 Specialist Request Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div
    x-data="formApp()"
    class="bg-white p-8 rounded-xl shadow-md w-full max-w-xl"
  >
    <h1 class="text-2xl font-bold mb-6">Specialist Request Form</h1>

    <!-- Loading -->
    <template x-if="step === 'loading'">
      <p>Loading questions...</p>
    </template>

    <!-- Form -->
    <template x-if="step === 'form'">
      <div>
        <p class="mb-4 text-lg font-semibold" x-text="currentQuestion.text"></p>

        <!-- Input type -->
        <template x-if="currentQuestion.type === 'input'">
          <div>
            <input
              type="text"
              x-model="userInput"
              class="border p-2 w-full mb-4 rounded"
              @keydown.enter.prevent="submitInput()"
              placeholder="Type your answer here"
            />
            <button
              @click="submitInput()"
              class="bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50"
              :disabled="!userInput.trim()"
            >
              Next
            </button>
          </div>
        </template>

        <!-- Choice type -->
        <template x-if="currentQuestion.type === 'choice'">
          <div>
            <template x-for="opt in currentQuestion.options" :key="opt.label">
              <button
                class="block w-full text-left bg-gray-200 hover:bg-green-200 px-4 py-2 mb-2 rounded"
                @click="selectOption(opt)"
                x-text="opt.label"
              ></button>
            </template>
          </div>
        </template>
      </div>
    </template>

    <!-- Output -->
    <template x-if="step === 'output'">
      <div class="mt-6">
        <h2 class="text-xl font-semibold mb-2">Your Request Text</h2>
        <textarea
          readonly
          class="w-full h-56 p-3 border rounded bg-gray-50 font-mono whitespace-pre-wrap"
          x-text="result"
          @click="$el.select()"
        ></textarea>
        <button
          @click="copyResult()"
          class="mt-3 bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded"
        >
          Copy to Clipboard
        </button>
        <p
          x-show="copied"
          x-transition
          class="text-green-600 mt-2"
        >
          Copied!
        </p>
      </div>
    </template>
  </div>

  <script>
    function formApp() {
      return {
        step: "loading",
        questions: [],
        currentId: null,
        answers: [],
        userInput: "",
        dataMap: {},
        copied: false,

        get currentQuestion() {
          return this.questions.find(q => q.id === this.currentId) || {};
        },

        async init() {
          try {
            const res = await fetch("risp-questions.json");
            this.questions = await res.json();
            this.currentId = "q1";
            this.step = "form";
          } catch (e) {
            console.error("Failed to load questions", e);
            this.step = "error";
          }
        },

        submitInput() {
          if (!this.userInput.trim()) return;
          this.answers.push({
            question: this.currentQuestion.text,
            answer: this.userInput,
            key: this.currentQuestion.key
          });
          this.dataMap[this.currentQuestion.key] = this.userInput.trim();
          this.userInput = "";
          if (this.currentQuestion.next === "end") {
            this.step = "output";
          } else {
            this.currentId = this.currentQuestion.next;
          }
        },

        selectOption(opt) {
          this.answers.push({
            question: this.currentQuestion.text,
            options: this.currentQuestion.options,
            selected: opt.label,
            key: this.currentQuestion.key
          });
          this.dataMap[this.currentQuestion.key] = opt.label;
          if (opt.next === "end") {
            this.step = "output";
          } else {
            this.currentId = opt.next;
          }
        },

        copyResult() {
          navigator.clipboard.writeText(this.result).then(() => {
            this.copied = true;
            setTimeout(() => (this.copied = false), 2000);
          });
        },

        get result() {
          let out = "```\n" + (this.dataMap.username || "") + "\n\n";
          this.answers.forEach(a => {
            out += `${a.question}\n`;
            if (a.answer !== undefined) {
              out += `✏️ ${a.answer}\n\n`;
            } else {
              a.options.forEach(opt => {
                out += `${opt.label === a.selected ? "✅" : "⬜"} ${opt.label}\n`;
              });
              out += "\n";
            }
          });
          out += "```";
          return out;
        },
      };
    }
    document.addEventListener("alpine:init", () => {
      Alpine.data("formApp", formApp);
    });
    document.addEventListener("DOMContentLoaded", () => {
      Alpine.store("formApp")?.init?.();
    });
  </script>
</body>
</html>
